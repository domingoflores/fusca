/// <reference path="References\Explore\SuiteScript\SuiteScriptAPI.js" />/* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * ** @ FILENAME      : SRSFinance.js * @ AUTHOR        : Upaya* @ DATE          : 2010/05/29** Copyright (c) 2010 Upaya - The Solution Inc. * 10530 N. Portal Avenue, Cupertino CA 95014* All Rights Reserved.** This software is the confidential and proprietary information of * Upaya - The Solution Inc. ("Confidential Information"). You shall not* disclose such Confidential Information and shall use it only in* accordance with the terms of the license agreement you entered into* with Upaya.** * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * */ var fx = 'SRS Participant Fianance Approval';var context = nlapiGetContext();var fields = new Array(  'custentity_bene_bank'						,'custentity_bene_aba_code'						,'custentity_bene_swift_code'						,'custentity_bene_bank_contact'						,'custentity_bene_account_name'						,'custentity_bene_account_number'						,'custentity_receiving_intermediary_bank'						,'custentity_rec_inter_aba_code'						,'custentity_rec_inter_swift_code'						,'custentity_payment_memo'						,'custentity_payment_info_approved');function updatecustomer(type){	var rec;	var old;	try	{		if (type == 'edit')		{			rec = nlapiGetNewRecord();			old = nlapiGetOldRecord();						var fieldchanged = false;			var ctr = fields.length - 1;			for(i=0; i < ctr; i++)			{				if(!fieldchanged) { fieldchanged = cmpfields(rec,old, fields[i]);}			}						var approvalchanged = cmpfields(rec,old, fields[ctr]);						if(fieldchanged)			{				sendEmail(old,rec);				nlapiSubmitField(rec.getRecordType(), rec.getId(), 'custentity_payment_info_approved', 2);				/*if(rec.getFieldValue('custentity_payment_info_approved') != 1)				{					return; //No further changes if payment info is not approved				}				if(!approvalchanged) //User does not have the permission				{					if(!validrole())					{						nlapiSubmitField(rec.getRecordType(), rec.getId(), 'custentity_payment_info_approved', 2);					}				}*/				// send out notification of the change			} //fieldchanged		} // if type	} //try	catch(e)	{		var err;	        	if ( e instanceof nlobjError )		{			err = e.getCode() + '\n' + e.getDetails();                	nlapiLogExecution( 'ERROR', fx + ' System error', err);		}		else		{			err = e.toString(); 			nlapiLogExecution( 'ERROR', fx + ' Unexpected error', err);		}	} //catch} // endfunction cmpfields(rec, old, field){	var f1 = rec.getFieldValue(field);	var f2 = old.getFieldValue(field);			return (diffval(f1, f2));	}//Return true if difffunction diffval(f1, f2){	if((!f1) && (!f2)) { return false;}	if((f1) && (!f2)) { return true;}	if((!f1) && (f2)) { return true;}		//Blanks are covered above	if(f1 == f2) { return false;}	else { return true;}	}function validrole(){	var ret = false;	var currrole= context.getRole();	var role;	for(i = 1; i <=5; i++)	{		var field = 'custscript_role' + i;		role = context.getSetting('SCRIPT', field);		if((role) && (role == currrole)) { return true;}	} //for}	function sendEmail(oldRecord,newRecord){	// get the id of the current user 	var currentContext = nlapiGetContext();	var currentUserID = currentContext.getUser();	if(currentUserID == null)	{		currentUserID = "6367";	}		var to = "operations@shareholderrep.com";	var subject = "Bank Payment Information changed - " + newRecord.getFieldValue("companyname");	var body = subject + "\n\n\n<table border=1><tr><th>Field</th><th>Old Value</th><th>New Value</th></tr>";		for(var i = 0; i < fields.length; i++)	{		var field = fields[i];				var oldVal = oldRecord.getFieldValue(field);		var newVal = newRecord.getFieldValue(field);				if(oldVal == newVal) continue; // skip..		if((oldVal == null || oldVal == "null") && (newVal == null || newVal == "" || newVal == "null")) continue; // skip				body += "<tr><td>" + field + "</td>";		body += "<td>" + oldVal + "</td>";		body += "<td>" + newVal + "</td></tr>";	}	body += "</table>";		var records = new Object();	records['entity'] = newRecord.getId();		nlapiSendEmail(currentUserID,to,subject,body,null,null,records);}